#!/bin/sh

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# -----------------------------------------------------------------------------
# -m ì˜µì…˜ ë°©ì§€
# -----------------------------------------------------------------------------

if ! grep -q "^#" "$commit_msg_file"; then
    echo "âŒ 'git commit -m' ì˜µì…˜ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "
ğŸ’¡ ë‹¤ìŒê³¼ ê°™ì´ í•©ë‹ˆë‹¤.
1. git commit (ì—”í„°)
2. í…œí”Œë¦¿ì— ë§ì¶° ì»¤ë°‹ ë©”ì„¸ì§€ ì‘ì„±
3. ì €ì¥ í›„ ì¢…ë£Œ
"
    exit 1
fi

# -----------------------------------------------------------------------------
# ì´ìŠˆ ID ì¶”ì¶œ ë° ìë™ ì¶”ê°€
# -----------------------------------------------------------------------------

# ë¸Œëœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
branch_name=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# ì´ìŠˆ ID ì¶”ì¶œ (ì˜ˆ: #1)
issue_id=$(echo "$branch_name" | LANG=C grep -oE '#[0-9]+' || echo "")
echo "ğŸ” ì¶”ì¶œëœ ì´ìŠˆ ID: $issue_id"

branch_name=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")


# ì£¼ì„ ì œì™¸í•œ ì»¤ë°‹ ë©”ì‹œì§€
filtered_msg=$(echo "$commit_msg" | grep -v '^#')

# ì´ìŠˆ IDê°€ ìˆê³ , ë©”ì‹œì§€ì— ì—†ëŠ” ê²½ìš° ì¶”ê°€
if [ ! -z "$issue_id" ] && ! echo "$filtered_msg" | grep -q "\[$issue_id\]"; then
    # ì£¼ì„ ë¼ì¸ì„ ì œì™¸í•˜ê³  ì´ìŠˆ IDë¥¼ ì•ì— ì¶”ê°€
    new_msg="[$issue_id] $filtered_msg"
    echo "$new_msg" > "$commit_msg_file"

    # ì£¼ì„ ë¶™ì´ê¸°
    echo "" >> "$commit_msg_file"
    echo "# ------------------------" >> "$commit_msg_file"
    echo "$commit_msg" | grep '^#' >> "$commit_msg_file"
fi

# -----------------------------------------------------------------------------
# ì»¤ë°‹ ë©”ì„¸ì§€ íŒ¨í„´ ê²€ì‚¬
# -----------------------------------------------------------------------------

commit_msg=$(cat "$commit_msg_file")
filtered_msg=$(echo "$commit_msg" | grep -v '^#')

# íŒ¨í„´: [#1] feat: ë©”ì‹œì§€
if ! echo "$filtered_msg" | grep -qE '^\[#([0-9]+)\]\s+(feat|fix|docs|refactor|test|config|design|edit): .+'; then
    echo "$filtered_msg"
    echo "âŒ ì˜ëª»ëœ ì»¤ë°‹ ë©”ì„¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤."
    echo "
ì˜¬ë°”ë¥¸ ì»¤ë°‹ ë©”ì„¸ì§€ ì˜ˆì‹œ:
[#1] feat: ì´ˆê¸° ì„¤ì • êµ¬ì„±
"
    exit 1
fi
